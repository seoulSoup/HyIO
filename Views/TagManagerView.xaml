<UserControl x:Class="HyIO.Views.TagManagerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="400" d:DesignWidth="800">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 상단 안내 -->
        <StackPanel Grid.Row="0"
                    Orientation="Horizontal"
                    Margin="8,0,0,8">
            <TextBlock Text="이미지에 태그를 부여해서 검색에 활용할 수 있습니다."
                       FontFamily="{StaticResource AppFontFamily}"
                       Foreground="{StaticResource AppTextSecondaryBrush}"
                       FontSize="14"/>
        </StackPanel>

        <!-- 태그 카드 그리드 + 커스텀 스크롤바 -->
        <ScrollViewer Grid.Row="1"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">

            <!-- 이 ScrollViewer 안에서만 쓰는 스타일들 -->
            <ScrollViewer.Resources>

                <!-- 먼저 Thumb 스타일 정의 (StaticResource 순서 중요!) -->
                <Style x:Key="TagThumbStyle" TargetType="Thumb">
                    <!-- TemplateBinding Background이 절대 UnsetValue가 되지 않도록 기본값 보장 -->
                    <Setter Property="Background"
                            Value="{StaticResource TagScrollBarThumbBackgroundBrush}"/>
                    <Setter Property="SnapsToDevicePixels" Value="True"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="Thumb">
                                <Border Background="{TemplateBinding Background}"
                                        CornerRadius="4"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background"
                                    Value="{StaticResource TagScrollBarThumbHoverBackgroundBrush}"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>

                <!-- 그 다음 ScrollBar 스타일 정의 -->
                <Style TargetType="ScrollBar">
                    <Setter Property="Orientation" Value="Vertical"/>
                    <Setter Property="Width" Value="10"/>
                    <Setter Property="Margin" Value="2,4"/>

                    <!-- TemplateBinding Background을 위한 기본값 -->
                    <Setter Property="Background"
                            Value="{StaticResource TagScrollBarTrackBackgroundBrush}"/>

                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ScrollBar">
                                <Grid>
                                    <!-- 트랙 배경 -->
                                    <Border Background="{TemplateBinding Background}"
                                            CornerRadius="5"/>

                                    <!-- 실제 스크롤 트랙 -->
                                    <Track x:Name="PART_Track"
                                           Orientation="{TemplateBinding Orientation}"
                                           Minimum="{TemplateBinding Minimum}"
                                           Maximum="{TemplateBinding Maximum}"
                                           Value="{TemplateBinding Value}"
                                           ViewportSize="{TemplateBinding ViewportSize}"
                                           IsDirectionReversed="True">

                                        <!-- 화살표 버튼 숨김 -->
                                        <Track.DecreaseRepeatButton>
                                            <RepeatButton Command="ScrollBar.LineUpCommand"
                                                          Visibility="Collapsed"
                                                          IsEnabled="False"/>
                                        </Track.DecreaseRepeatButton>
                                        <Track.IncreaseRepeatButton>
                                            <RepeatButton Command="ScrollBar.LineDownCommand"
                                                          Visibility="Collapsed"
                                                          IsEnabled="False"/>
                                        </Track.IncreaseRepeatButton>

                                        <!-- Thumb -->
                                        <Track.Thumb>
                                            <Thumb Style="{StaticResource TagThumbStyle}"/>
                                        </Track.Thumb>
                                    </Track>
                                </Grid>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>

            </ScrollViewer.Resources>

            <!-- 실제 태그 카드 목록 -->
            <ItemsControl x:Name="TagGrid">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Width="216"
                                Margin="4"
                                Padding="8"
                                CornerRadius="12"
                                Background="{StaticResource AppSurfaceAltBrush}">
                            <StackPanel>
                                <!-- 썸네일 -->
                                <Image Source="{Binding Thumbnail}"
                                       Width="200"
                                       Height="200"
                                       Stretch="UniformToFill"
                                       Margin="0,0,0,8"
                                       SnapsToDevicePixels="True"/>

                                <!-- 파일 이름 -->
                                <TextBlock Text="{Binding FileName}"
                                           Foreground="{StaticResource AppTextPrimaryBrush}"
                                           FontSize="12"
                                           FontFamily="{StaticResource AppFontFamily}"
                                           TextTrimming="CharacterEllipsis"/>

                                <!-- 태그 입력 TextBox (둥근 모서리 + 세로 중앙 정렬) -->
                                <TextBox Margin="0,6,0,4"
                                         Height="28"
                                         Padding="6,2"
                                         FontFamily="{StaticResource AppFontFamily}"
                                         FontSize="12"
                                         Foreground="{StaticResource AppTextSecondaryBrush}"
                                         Background="{StaticResource AppSurfaceBrush}"
                                         BorderBrush="{StaticResource AppBorderBrush}"
                                         BorderThickness="1"
                                         VerticalContentAlignment="Center"
                                         Text="{Binding NewTagText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         KeyDown="TagTextBox_KeyDown"
                                         GotFocus="TagTextBox_GotFocus"
                                         LostFocus="TagTextBox_LostFocus">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <!-- 여기서도 TemplateBinding Background 안 쓰고 고정 Brush 사용 -->
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="TextBox">
                                                        <Border Background="#FFBEE6FD"
                                                                BorderBrush="{StaticResource AppBorderBrush}"
                                                                BorderThickness="1"
                                                                CornerRadius="8">
                                                            <ScrollViewer x:Name="PART_ContentHost"
                                                                          Margin="0"
                                                                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>

                                <!-- 입력된 태그 칩들 -->
                                <ItemsControl ItemsSource="{Binding Tags}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>

                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#EDE9FE"
                                                    CornerRadius="12"
                                                    Margin="0,0,4,4"
                                                    Padding="6,2">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding}"
                                                               FontSize="11"
                                                               Margin="0,0,4,0"
                                                               FontFamily="{StaticResource AppFontFamily}"
                                                               Foreground="{StaticResource AppTextPrimaryBrush}"/>

                                                    <!-- X 버튼 (TemplateBinding + CornerRadius + Hover) -->
                                                    <Button Width="14"
                                                            Height="14"
                                                            Padding="0"
                                                            Cursor="Hand"
                                                            Click="RemoveTagButton_Click"
                                                            CommandParameter="{Binding}">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <!-- TemplateBinding Background/Foreground용 기본값 -->
                                                                <Setter Property="Background"
                                                                        Value="{StaticResource TagChipCloseButtonBackgroundBrush}"/>
                                                                <Setter Property="Foreground"
                                                                        Value="{StaticResource TagChipCloseButtonForegroundBrush}"/>
                                                                <Setter Property="BorderThickness" Value="0"/>
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}"
                                                                                    CornerRadius="7">
                                                                                <ContentPresenter HorizontalAlignment="Center"
                                                                                                  VerticalAlignment="Center"/>
                                                                            </Border>
                                                                            <ControlTemplate.Triggers>
                                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                                    <Setter Property="Background"
                                                                                            Value="{StaticResource TagChipCloseButtonHoverBackgroundBrush}"/>
                                                                                    <Setter Property="Foreground"
                                                                                            Value="{StaticResource TagChipCloseButtonHoverForegroundBrush}"/>
                                                                                </Trigger>
                                                                            </ControlTemplate.Triggers>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </Style>
                                                        </Button.Style>

                                                        <TextBlock Text="X"
                                                                   FontSize="11"
                                                                   VerticalAlignment="Center"
                                                                   HorizontalAlignment="Center"
                                                                   FontFamily="{StaticResource AppFontFamily}"/>
                                                    </Button>

                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
